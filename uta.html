<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head>
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif+JP:600&display=swap" rel="stylesheet">
<style>
    p{font-family:'Noto Serif JP',serif;}
    body{
        font-family:'Noto Serif JP',serif;
        -webkit-text-size-adjust: 100%;
    }
</style>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>東方ニコ楽祭 歌詠み一覧</title>
</head>

<body>
<script type="text/javascript">

    /* ここからメンテナンス範囲 */

    //読み込むcsvリスト
    var festnames=["tsukimi","hanami","syuen","5th","6th","7th","8th","9th"];   //URLのfest=につけるお祭り英語表記
    var festinfo = [];
    //["読み込むcsvの名前","表示するお祭り名"];
    festinfo[festnames[0]] = ["tsukimi.csv","月見"];
    festinfo[festnames[1]] = ["hanami.csv","花見"];
    festinfo[festnames[2]] = ["syuen.csv","酒宴"];
    festinfo[festnames[3]] = ["",""];    //ここに歌のcsvのファイル名と漢字名を入力していく。
    festinfo[festnames[4]] = ["",""];
    festinfo[festnames[5]] = ["",""];
    festinfo[festnames[6]] = ["",""];
    festinfo[festnames[7]] = ["",""];

    /* ここまでメンテナンス範囲 */

    var regexp = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i;
    var isMobile = (window.navigator.userAgent.search(regexp) !== -1);    //スマホ系の場合はtrue

    var urlParam = location.search.substring(1);
    
    var utaCount = 0;
    var allCount = 0;

    var fest = [];  //csvを読み込むお祭り番号を格納する。
    fest[0] = "all";    //allのときはすべてのお祭りを読み込む(あとで全部のお祭り番号をコピーする)
    var paramIllust = "";
    var userName = "";
    var illustFlg = 0;  //イラスト指定(im番号)のときは1にする
    var festFlg = 0;
    var hankakuFlg = 0;
    var bubunFlg = 0;
    var mode = "";

    if(urlParam) {
        // 「&」が含まれている場合は「&」で分割
        var param = urlParam.split('&');
        var array = []; //読み込んだcsvを格納する

        var printedIllust = "im"; //前回表示したイラストのim番号

        var paramArray = [];    //パラメータ格納用の配列

        //配列にパラメータを格納
        for (i = 0; i < param.length; i++) {
            var paramItem = param[i].split('=');
            paramArray[paramItem[0]] = paramItem[1];
            if(paramItem[0]=="user"){
                userName = paramArray.user;
                userName = decodeURI(userName);
            }else if(paramItem[0]=="illust"){
                illustFlg = 1;
                paramIllust = paramArray.illust;
            }else if(paramItem[0] == "fest"){
                festFlg = 1;
                fest[0] = paramArray.fest;
            }else if(paramItem[0] == "mode"){
                mode = paramArray.mode;
            }else if(paramItem[0] == "hankaku"){
                hankakuFlg = 1;
            }else if(paramItem[0] == "bubun"){
                bubunFlg = 1;
            }
        }
    }


    //フォームの設定
    document.write("<form name='form' id='form' action=''>");

    //お祭り選択を表示する
    document.write("<table border='1' rules='all'><tr><td width='110' align='center'>お祭り選択</td><td width='200'>");
    document.write("<select name='fest'");

    document.write("><option value='all'>全部</option>");
    var tmpselected = "";
    for(i=0;i<festnames.length;i++){
        if(festinfo[festnames[i]][0]!=""){
            if(festnames[i]==fest[0]){
                tmpselected = "selected ";
            }else{
                tmpselected = "";
            }
            document.write("<option " + tmpselected + "value='" + festnames[i] + "'>東方ニコ楽祭・" + festinfo[festnames[i]][1] +"</option>");
        }
    }
    document.write("</td></tr>");
    //イラスト指定を表示する
    document.write("<tr><td align='center'>イラスト指定</td><td>");
    document.write("<input type='text' name='illust' maxlength='10' value='");
    if(paramIllust.length>2){
        document.write(paramIllust + "'></td></tr>");
    }else{
        document.write("im'></td></tr>");
    }

    //詠み人指定を表示する
    document.write("<tr><td align='center'>詠み人指定</td><td>");
    document.write("<input type='text' name='user'");
    if(userName.length>0){
        document.write(" value='" + userName + "'");
    }
    document.write("><br><input type='checkbox' name='userHankaku' checked='checked'> 半角全角を無視する。<br>");
    document.write("<input type='checkbox' name='userBubun'> 部分一致で検索する。");
    document.write("</td></tr></table>");
    document.write("<p><input type='button' value='表示' onclick='link()'/></p></hr></form><hr>");

    if(fest[0]=="all"){
            fest = festnames;
    }

    // URLにパラメータが存在する場合
    if(mode.length>0){
        if(mode=="illustlist"){
            var illustCount = 0;
            for(j=0;j<fest.length;j++){
            utaCount = 0;
            var array = loadFile(festinfo[fest[j]][0]);
            document.write("<table>");
            for(i=0; i<utaCount; i++){
                if(array[i][0] != printedIllust){   //前に表示したイラストと異なる場合のみイラスト情報を表示する。
                    if(isMobile||illustCount%3==0){
                        document.write("</tr><tr><td>");
                    }else{
                        document.write("<td>");
                    }
                    imgiframe = "<iframe width='312' height='176' src='https://ext.seiga.nicovideo.jp/thumb/"+ array[i][0] +"' scrolling='no' style='border:solid 1px #888;' frameborder='0'><a href='https://seiga.nicovideo.jp/seiga/"+ array[i][0] +"'> " + array[i][1] + "</a></iframe>"
                    document.write(imgiframe);
                    document.write("<br><font size='3'><a href='uta.html?illust=" + array[i][0] + "'>このイラストの歌をもっと見る</a></font></td>");
                    printedIllust = array[i][0];
                    }
                }
            }
            document.write("</tr></table>");
        }else if(mode=="userlist"){
            // 幅サイズの指定
            if(isMobile){
                var tdsize = 300;
            }else{
                var tdsize = 300;
            }

            document.write("<h1>詠み人一覧</h1>");
            document.write("<table class='usersTable' width='560' border='3' rules='all' bgcolor='azure'>");

            var users = [];
            var usersCount = [];

            for(j=0;j<fest.length;j++){
                utaCount = 0;
                var array = loadFile(festinfo[fest[j]][0]);
                for(i=0;i<utaCount;i++){
                    if(users.indexOf(array[i][4])==-1){  //見つからなかったとき
                        users.push(array[i][4]);
                        usersCount[array[i][4]] = 1;
                    }else{
                        usersCount[array[i][4]]++;
                    }
                }
            }
            users.sort();
            for(i=0; i<(users.length/2); i++){
                document.write("<tr><td width='" + tdsize + "' align='center'><a href='uta.html?user=" + users[i*2] + "'>" + users[i*2]+"</a></td>");
                if(i*2+1 <= users.length){
                    if(isMobile){
                        document.write("</tr><tr>")
                    }
                    document.write("<td width='" + tdsize + "' align='center'><a href='uta.html?user=" + users[i*2+1] + "'>" + users[i*2+1]+"</a></td>");
                }else{
                    document.write("<td></td>");
                }
                document.write("</tr>");
            }
        }

    }else if(urlParam){
        for(j=0;j<fest.length;j++){
            utaCount = 0;
            var array = loadFile(festinfo[fest[j]][0]);
            for(i=0; i<utaCount; i++){
                if((userName.length>0 || array[i][4].trim() == userName) && (paramIllust.length>2 || array[i][0] == paramIllust)){
                    if(array[i][0] != printedIllust){   //前に表示したイラストと異なる場合のみイラスト情報を表示する。
                        imgiframe = "<iframe width='312' height=\"176\" src=\"https://ext.seiga.nicovideo.jp/thumb/"+ array[i][0] +"\" scrolling=\"no\" style=\"border:solid 1px #888;\" frameborder=\"0\"><a href=\"https://seiga.nicovideo.jp/seiga/"+ array[i][0] +"\"> " + array[i][1] + "</a></iframe>"
                        document.write(imgiframe);
                        if(isMobile){
                            document.write("<br><font size='3'><a href='uta.html?illust=" + array[i][0] + "'>このイラストの歌をもっと見る</a></font>");
                        }else{
                            document.write("<font size='3'>　　<a href='uta.html?illust=" + array[i][0] + "'>このイラストの歌をもっと見る</a></font>");
                        }
                        
                        printedIllust = array[i][0];
                    }
                    document.write("<table width='560' border='3' rules='none' bgcolor='ivory'><body text='#000000'><p align='center'>");
                    document.write("<tr><td align=left>　" + array[i][2] + "</td></tr>");
                    document.write("<tr><td align=center>" + array[i][3] + "</td></tr>");
                    document.write("<tr><td align=right>" + array[i][4] + "　</td></tr></table>");

                    document.write("<p><font size='3'><a href='uta.html?user=" + array[i][4] + "'>この詠み手の歌をもっと見る</a></font></p><br><br>");
                    allCount = allCount + 1;
                }
            }
        }
    }else{


    function loadFile(filename){
        var fileData = new XMLHttpRequest();
        var resultArray = new Array();

        if(filename.length!=0){
            var filePath = "uta/" + filename;

            fileData.open("get", filePath, false);
            fileData.send(null);

            var lines = fileData.responseText.replace(/""/g,"【ダブルクォート2個】").replace(/"/g,"").replace(/【ダブルクォート2個】/g,'"').split("\n");

            for(var i=0; i<lines.length; i++){
                var tmp = lines[i].split(",");
                if(tmp.length != 1){
                    resultArray.push(tmp);
                    utaCount = utaCount + 1;
                }
            }
        }
        return resultArray;
    }

    function link(){
        var url = "uta.html?fest=" + document.form.fest.value;
        if(document.form.user.value != ""){
            url = url + "&user=" + document.form.user.value;
            if(document.form.userHankaku[0].checked){
                url = url + "&hankaku";
            }
            if(document.form.userBubun[0].checked){
                url = url + "&bubun";
            }
        }
        if(document.form.illust.value != "" && document.form.illust.value != "im"){
            url = url + "&illust=" + document.form.illust.value;
        }
        location.href = url;
    }

    function toHankaku(text){
        var result = text.replace(/[！-～]/g,
        function(tmp){
            return String.fromCharCode(tmp.charCodeAt(0) - 0xFEE0);
        });
        return result;
    }

</script>
<p><a href="index.html">トップへ戻る</a></p>
</body></html>
